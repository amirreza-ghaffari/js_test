{% extends 'base/base.html' %}
{% load static %}
{% load replace %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    {% block title %}
    {% endblock %}
</head>
<body>

{% block dashboard %}
    <h4>{{ flowchart }} History Detail</h4>
{% endblock %}

{% block content %}
    <div style="text-align: center">
        <h2>Blocks History</h2>
        <hr style="background-color: black">
        <div class="card-body table-responsive">
            <table id="dtverTable" class="table table-striped table-bordered table-sm">
                <thead class="thead-light">
                <tr>
                    <th style="min-width:200px" class="text-center" scope="col">Block</th>
                    <th class="text-center" scope="col">By User</th>
                    <th class="text-center" scope="col">Date</th>
                    <th class="text-center" scope="col">State</th>
                    <th class="text-center" scope="col">Action</th>
                </tr>
                </thead>
                <tbody>

                {% for k, v in block_history.items %}
                    <tr class="text-center">
                        <td class="text-center"> {{ v.label }}</td>
                        <td class="text-center"> {{ v.user }}</td>
                        <td class="text-center"> {{ v.change_date }}</td>
                        <td class="text-center"> {{ v.changes.0.field|replace_active }}</td>
                        <td class="text-center">
                            <button class="btn btn-outline-info" type="submit" onclick="getCommentHistory({{ k }})">Show
                                Comments
                            </button>
                        </td>
                    </tr>

                {% endfor %}

                </tbody>
            </table>
        </div>
    </div>

    <div style="text-align: center">
        <hr style="background-color: black">
        <h2>Comments History</h2>
        <div class="card-body table-responsive" id="comment-card">

            {#            <table class="table table-striped table-bordered table-sm">#}
            {#                <thead class="thead-light">#}
            {#                <tr>#}
            {#                    <th class="text-center" scope="col">Block</th>#}
            {#                    <th class="text-center" scope="col">By User</th>#}
            {#                    <th class="text-center" scope="col">Date</th>#}
            {#                    <th class="text-center" scope="col">State</th>#}
            {#                </tr>#}
            {#                </thead>#}
            {#                <tbody>#}
            {##}
            {#                                <tr class="text-center">#}
            {#                                    <td class="text-center"> x</td>#}
            {#                                    <td class="text-center"> x</td>#}
            {#                                    <td class="text-center"> x</td>#}
            {#                                    <td class="text-center"> x</td>#}
            {#                                </tr>#}
            {##}
            {#                </tbody>#}
            {#            </table>#}
        </div>
    </div>

    <script>

        $(document).ready(function () {
            $('#dtverTable').DataTable({
                "scrollY": "600px",
                "scrollCollapse": true,
            });
            $('.dataTables_length').addClass('bs-select');
        });

        function getCommentHistory(block_id) {
            var tableCard = document.getElementById("comment-card")
            tableCard.innerHTML = ""
            $.ajax({
                type: 'GET',
                dataType: "json",
                url: "/flowchart/api/v1/HistoryChange/" + {{ history_id }} +"/",
                success: function (data, status, xhr) {

                    var commentHistory = JSON.parse(data.comment_history)

                    var table = document.createElement("table")
                    table.classList = "table table-striped table-bordered table-sm"
                    table.id = "comment"
                    var head = document.createElement("thead")
                    head.classList = "thead-light"

                    var body = document.createElement("tbody")

                    var th1 = document.createElement("th")
                    th1.classList = "text-center"
                    th1.scope = "col"
                    th1.innerText = "block"

                    var th2 = document.createElement("th")
                    th2.classList = "text-center"
                    th2.scope = "col"
                    th2.innerText = "By User"

                    var th3 = document.createElement("th")
                    th3.classList = "text-center"
                    th3.scope = "col"
                    th3.innerText = "Date"

                    var th4 = document.createElement("th")
                    th4.classList = "text-center"
                    th4.scope = "col"
                    th4.innerText = "Text"

                    var tr = document.createElement("tr")

                    tr.appendChild(th1)
                    tr.appendChild(th2)
                    tr.appendChild(th3)
                    tr.appendChild(th4)

                    head.appendChild(tr)


                    for (let i = 0; i < Object.keys(commentHistory).length; i++) {
                        var id = Object.keys(commentHistory)[i]
                        var info = commentHistory[id]
                        if (info.block_id === block_id) {
                            var tr = document.createElement('tr')
                            tr.classList = "text-center"

                            var td1 = document.createElement("td")
                            td1.classList = "text-center"
                            td1.innerHTML = info.block

                            var td2 = document.createElement("td")
                            td2.classList = "text-center"
                            td2.innerHTML = info.author

                            var td3 = document.createElement("td")
                            td3.classList = "text-center"
                            td3.innerHTML = info.date

                            var td4 = document.createElement("td")
                            td4.classList = "text-center"
                            td4.innerHTML = info.text

                            tr.appendChild(td1)
                            tr.appendChild(td2)
                            tr.appendChild(td3)
                            tr.appendChild(td4)

                            body.appendChild(tr)

                        }

                    }
                    table.appendChild(head)
                    table.appendChild(body)

                    tableCard.appendChild(table)
                    $(document).ready(function () {
                        $('#comment').DataTable({
                            "scrollY": "600px",
                            "scrollCollapse": true,
                        });
                        $('.dataTables_length').addClass('bs-select');
                    });
                }
            });
            element = document.getElementById("comment-card");
            element.scrollIntoView();
        }

    </script>

{% endblock %}
</body>
</html>