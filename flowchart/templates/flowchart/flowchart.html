{% extends 'base/base.html' %}
{% load static %}
{% block title %} {{ flowchart_name }} {% endblock %}

{% block head %}
    <script src="{% static 'js/go.js' %}"></script>
    <script src="{% static 'js/DrawCommandHandler.js' %}"></script>
    <script src="{% static 'js/figures.js' %}"></script>
    <script src="{% static 'js/hyperlink.js' %}"></script>
    <!-- HTML To Canvas for screenshots --->
    <script type="text/javascript" src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

{% endblock %}

{% block dashboard %}
    {{ flowchart_name }}
    <h5 id="triggered_date" style="display: none"></h5>
    <hr>
    <div style="text-align: left">
        <button type="button" class="btn btn-outline-primary" onclick="resetFlowchart()">Reset Flowchart</button>
        <button type="button" class="btn btn-outline-secondary" onclick="endIncident()">End Incident</button>
        <button type="button" class="btn btn-outline-info" id="loadModel" onclick="load()">Load</button>
    </div>


{% endblock %}

{% block content %}


    <div id="sample">
    <div id="myDiagramDiv"
         style="border: 1px solid black; background-color: rgb(255, 255, 255); width: 100%; height: 800px; position: relative; cursor: auto">
        <canvas tabindex="0"
                style="position: absolute; top: 10px; left: 0px;  z-index: 2; user-select: none; touch-action: none; width: 1054px; height: 598px; cursor: auto;"
                width="1054" height="598">This text is displayed if your browser does not support the Canvas HTML
            element.
        </canvas>
        <div style="position: absolute; overflow: auto; width: 1054px; height: 598px; z-index: 1;">
            <div style="position: absolute; width: 1px; height: 1px;"></div>
        </div>
    </div>

    <br>

    <!-- Sent Card --->
    <div class="card card-dark">
        <div class="card-header">
            <h3 class="card-title">Approve</h3>
        </div>
        <div class="card-body" id="send-table">
        </div>
        <div class="card-footer">
            <a href="">View the history of approved blocks</a>
        </div>

    </div>


    <!-- Transitions Card --->
    <div class="card" id="transient-table-card">
        <div style="background-color: rgb(64, 78, 89); text-align: center" class="card-header">
            <h4 style="color: white">Choose Path</h4>
        </div>

        <div class="card-body">
            <table id="transient-table" class="table table-bordered table-striped" style="text-align: center">
                <thead>
                <tr>
                    <th>PATH 1</th>
                    <th>PATH 2</th>
                </tr>
                </thead>
                <tbody id="transient-table-body">

                </tbody>
            </table>
        </div>
    </div>


    <!-- comment Card --->
    <div class="card card-dark">
        <div class="card-header">
            <h3 class="card-title">Comments and Messages</h3>
        </div>

        <div class="card-body">
            <table id="comment-table" class="table table-bordered table-striped" style="text-align: center">
                <thead>
                <tr>
                    <th>Subject</th>
                    <th>Description</th>
                    <th>Action</th>
                    <th>Updated Date</th>
                    <th>User</th>
                </tr>
                </thead>
                <tbody id="comment-table-body">

                </tbody>
            </table>
        </div>
        <div class="card-body">
            <div class="col">


                <div class="form-group">
                    <label>Subject: </label>
                    <input type="text" class="form-control" id="label-input" placeholder="Enter subject"
                           style="margin: 0!important;border: 1px solid black!important;">
                </div>


                <div class="col-md-6" data-select2-id="29">
                    <div class="form-group">
                        <label>Choose Action: </label>
                        <select class="form-control"
                                style="width: 100%; border: 1px solid black!important"
                                data-select2-id="1" tabindex="-1" aria-hidden="true" id="select-body">
                        </select>
                    </div>
                    <!-- /.form-group -->
                </div>
                <textarea class="form-control bg-white" type="text" name="text" id="text-comment"
                          style="border: 1px solid black!important; resize: none"
                          placeholder="Enter Your Comment ..."
                          rows="5"></textarea>
                <br>
                <button class="btn btn-info" id="btn_comment" name="btn_comment" onclick="submitComment()"
                        type="submit">Submit new Comment
                </button>
            </div>
        </div>
    </div>


    <textarea id="mySavedModel" style="width:100%;height:300px;display: none">
                  {{ a }}
    </textarea>


    <script id="code">
        var nodeDataArray = {};
        var linkDataArray = {};
        var fullDataArray = {};
        var totalObjects = null;
        var commentId = null

        $(function () {
            //Initialize Select2 Elements
            $('.select2').select2()

            //Initialize Select2 Elements
            $('.select2bs4').select2({
                theme: 'bootstrap4'
            })
        })

        function init() {

            // Since 2.2 you can also author concise templates with method chaining instead of GraphObject.make
            // For details, see https://gojs.net/latest/intro/buildingObjects.html
            const $ = go.GraphObject.make;
            myDiagram =
                $(go.Diagram, "myDiagramDiv",
                    {
                        autoScale: go.Diagram.Uniform,
                        padding: 10,  // extra space when scrolled all the way
                        "draggingTool.isGridSnapEnabled": true,
                        handlesDragDropForTopLevelParts: true,
                        mouseDrop: e => {
                            // when the selection is dropped in the diagram's background,
                            // make sure the selected Parts no longer belong to any Group
                            var ok = e.diagram.commandHandler.addTopLevelParts(e.diagram.selection, true);
                            if (!ok) e.diagram.currentTool.doCancel();
                        },
                        commandHandler: $(DrawCommandHandler),  // support offset copy-and-paste
                        "clickCreatingTool.archetypeNodeData": {text: "NEW NODE"},  // create a new node by double-clicking in background
                        "PartCreated": e => {
                            var node = e.subject;  // the newly inserted Node -- now need to snap its location to the grid
                            node.location = node.location.copy().snapToGridPoint(e.diagram.grid.gridOrigin, e.diagram.grid.gridCellSize);
                            setTimeout(() => {  // and have the user start editing its text
                                e.diagram.commandHandler.editTextBlock();
                            }, 20);
                        },
                        "commandHandler.archetypeGroupData": {isGroup: true, text: "NEW GROUP"},
                        "SelectionGrouped": e => {
                            var group = e.subject;
                            setTimeout(() => {  // and have the user start editing its text
                                e.diagram.commandHandler.editTextBlock();
                            })
                        },
                        "LinkRelinked": e => {
                            // re-spread the connections of other links connected with both old and new nodes
                            var oldnode = e.parameter.part;
                            oldnode.invalidateConnectedLinks();
                            var link = e.subject;
                            if (e.diagram.toolManager.linkingTool.isForwards) {
                                link.toNode.invalidateConnectedLinks();
                            } else {
                                link.fromNode.invalidateConnectedLinks();
                            }
                        },
                        "undoManager.isEnabled": true
                    });


            // Node template

            myDiagram.nodeTemplate =
                $(go.Node, "Auto",
                    {
                        locationSpot: go.Spot.Center, locationObjectName: "SHAPE",
                        desiredSize: new go.Size(120, 60), minSize: new go.Size(40, 40),
                        resizable: true, resizeCellSize: new go.Size(20, 20)
                    },
                    // these Bindings are TwoWay because the DraggingTool and ResizingTool modify the target properties
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    new go.Binding("desiredSize", "size", go.Size.parse).makeTwoWay(go.Size.stringify),
                    $(go.Shape,
                        { // the border
                            name: "SHAPE", fill: "white",
                            portId: "", cursor: "pointer",
                            fromLinkable: true, toLinkable: true,
                            fromLinkableDuplicates: true, toLinkableDuplicates: true,
                            fromSpot: go.Spot.AllSides, toSpot: go.Spot.AllSides
                        },
                        new go.Binding("figure"),
                        new go.Binding("fill"),
                        new go.Binding("stroke", "color"),
                        new go.Binding("strokeWidth", "thickness"),
                        new go.Binding("strokeDashArray", "dash")),
                    // this Shape prevents mouse events from reaching the middle of the port
                    $(go.Shape, {width: 100, height: 40, strokeWidth: 0, fill: "transparent"}),
                    $(go.TextBlock,
                        {
                            margin: 1,
                            textAlign: "center",
                            overflow: go.TextBlock.OverflowEllipsis,
                            editable: true,
                            font: "25pt sans-serif"
                        },
                        // this Binding is TwoWay due to the user editing the text with the TextEditingTool
                        new go.Binding("text").makeTwoWay(),
                        new go.Binding("stroke", "color")),
                    $("HyperlinkText",
                        function (node) {
                            return "http://127.0.0.1:8000" + node.data.block_info;
                        },
                        function (node) {
                            return node.data.text;
                        },
                        {
                            margin: 1,
                            textAlign: "center",
                            overflow: go.TextBlock.OverflowEllipsis,
                            editable: true,
                            font: "25pt sans-serif"
                        }
                    ),
                );

            myDiagram.nodeTemplate.toolTip =
                $("ToolTip",  // show some detailed information
                    $(go.Panel, "Vertical",
                        {maxSize: new go.Size(200, NaN)},  // limit width but not height
                        $(go.TextBlock,
                            {font: "25pt sans-serif", textAlign: "center"},
                            new go.Binding("text")),
                        $(go.TextBlock,
                            {font: "25pt sans-serif", textAlign: "center"},
                            new go.Binding("text", "details"))
                    )
                );

            // Node selection adornment
            // Include four large triangular buttons so that the user can easily make a copy
            // of the node, move it to be in that direction relative to the original node,
            // and add a link to the new node.

            function makeArrowButton(spot, fig) {
                var maker = (e, shape) => {
                    e.handled = true;
                    e.diagram.model.commit(m => {
                        var selnode = shape.part.adornedPart;
                        // create a new node in the direction of the spot
                        var p = new go.Point().setRectSpot(selnode.actualBounds, spot);
                        p.subtract(selnode.location);
                        p.scale(2, 2);
                        p.x += Math.sign(p.x) * 60;
                        p.y += Math.sign(p.y) * 60;
                        p.add(selnode.location);
                        p.snapToGridPoint(e.diagram.grid.gridOrigin, e.diagram.grid.gridCellSize);
                        // make the new node a copy of the selected node
                        var nodedata = m.copyNodeData(selnode.data);
                        // add to same group as selected node
                        m.setGroupKeyForNodeData(nodedata, m.getGroupKeyForNodeData(selnode.data));
                        m.addNodeData(nodedata);  // add to model
                        // create a link from the selected node to the new node
                        var linkdata = {from: selnode.key, to: m.getKeyForNodeData(nodedata)};
                        m.addLinkData(linkdata);  // add to model
                        // move the new node to the computed location, select it, and start to edit it
                        var newnode = e.diagram.findNodeForData(nodedata);
                        newnode.location = p;
                        e.diagram.select(newnode);
                        setTimeout(() => {
                            e.diagram.commandHandler.editTextBlock();
                        }, 20);
                    });
                };
                return $(go.Shape,
                    {
                        figure: fig,
                        alignment: spot, alignmentFocus: spot.opposite(),
                        width: (spot.equals(go.Spot.Top) || spot.equals(go.Spot.Bottom)) ? 36 : 18,
                        height: (spot.equals(go.Spot.Top) || spot.equals(go.Spot.Bottom)) ? 18 : 36,
                        fill: "orange", strokeWidth: 0,
                        isActionable: true,  // needed because it's in an Adornment
                        click: maker, contextClick: maker
                    });
            }

            // create a button that brings up the context menu
            function CMButton(options) {
                return $(go.Shape,
                    {
                        fill: "orange", stroke: "gray", background: "transparent",
                        geometryString: "F1 M0 0 M0 4h4v4h-4z M6 4h4v4h-4z M12 4h4v4h-4z M0 12",
                        isActionable: true, cursor: "context-menu",
                        click: (e, shape) => {
                            e.diagram.commandHandler.showContextMenu(shape.part.adornedPart);
                        }
                    },
                    options || {});
            }

            myDiagram.nodeTemplate.selectionAdornmentTemplate =
                $(go.Adornment, "Spot",
                    $(go.Placeholder, {padding: 10}),
                    makeArrowButton(go.Spot.Top, "TriangleUp"),
                    makeArrowButton(go.Spot.Left, "TriangleLeft"),
                    makeArrowButton(go.Spot.Right, "TriangleRight"),
                    makeArrowButton(go.Spot.Bottom, "TriangleDown"),
                    CMButton({alignment: new go.Spot(0.75, 0)})
                );

            // Common context menu button definitions

            // All buttons in context menu work on both click and contextClick,
            // in case the user context-clicks on the button.
            // All buttons modify the node data, not the Node, so the Bindings need not be TwoWay.

            // A button-defining helper function that returns a click event handler.
            // PROPNAME is the name of the data property that should be set to the given VALUE.
            function ClickFunction(propname, value) {
                return (e, obj) => {
                    e.handled = true;  // don't let the click bubble up
                    e.diagram.model.commit(m => {
                        m.set(obj.part.adornedPart.data, propname, value);
                    });
                };
            }

            // Create a context menu button for setting a data property with a color value.
            function ColorButton(color, propname) {
                if (!propname) propname = "color";
                return $(go.Shape,
                    {
                        width: 16, height: 16, stroke: "lightgray", fill: color,
                        margin: 1, background: "transparent",
                        mouseEnter: (e, shape) => shape.stroke = "dodgerblue",
                        mouseLeave: (e, shape) => shape.stroke = "lightgray",
                        click: ClickFunction(propname, color), contextClick: ClickFunction(propname, color)
                    });
            }

            function LightFillButtons() {  // used by multiple context menus
                return [
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            ColorButton("white", "fill"), ColorButton("beige", "fill"), ColorButton("aliceblue", "fill"), ColorButton("lightyellow", "fill")
                        )
                    ),
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            ColorButton("lightgray", "fill"), ColorButton("lightgreen", "fill"), ColorButton("lightblue", "fill"), ColorButton("pink", "fill")
                        )
                    )
                ];
            }

            function DarkColorButtons() {  // used by multiple context menus
                return [
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            ColorButton("black"), ColorButton("green"), ColorButton("blue"), ColorButton("red")
                        )
                    ),
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            ColorButton("brown"), ColorButton("magenta"), ColorButton("purple"), ColorButton("orange")
                        )
                    )
                ];
            }

            // Create a context menu button for setting a data property with a stroke width value.
            function ThicknessButton(sw, propname) {
                if (!propname) propname = "thickness";
                return $(go.Shape, "LineH",
                    {
                        width: 16, height: 16, strokeWidth: sw,
                        margin: 1, background: "transparent",
                        mouseEnter: (e, shape) => shape.background = "dodgerblue",
                        mouseLeave: (e, shape) => shape.background = "transparent",
                        click: ClickFunction(propname, sw), contextClick: ClickFunction(propname, sw)
                    });
            }

            // Create a context menu button for setting a data property with a stroke dash Array value.
            function DashButton(dash, propname) {
                if (!propname) propname = "dash";
                return $(go.Shape, "LineH",
                    {
                        width: 24, height: 16, strokeWidth: 2,
                        strokeDashArray: dash,
                        margin: 1, background: "transparent",
                        mouseEnter: (e, shape) => shape.background = "dodgerblue",
                        mouseLeave: (e, shape) => shape.background = "transparent",
                        click: ClickFunction(propname, dash), contextClick: ClickFunction(propname, dash)
                    });
            }

            function StrokeOptionsButtons() {  // used by multiple context menus
                return [
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            ThicknessButton(1), ThicknessButton(2), ThicknessButton(3), ThicknessButton(4)
                        )
                    ),
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            DashButton(null), DashButton([2, 4]), DashButton([4, 4])
                        )
                    )
                ];
            }

            // Node context menu

            function FigureButton(fig, propname) {
                if (!propname) propname = "figure";
                return $(go.Shape,
                    {
                        width: 32, height: 32, scale: 0.5, fill: "lightgray", figure: fig,
                        margin: 1, background: "transparent",
                        mouseEnter: (e, shape) => shape.fill = "dodgerblue",
                        mouseLeave: (e, shape) => shape.fill = "lightgray",
                        click: ClickFunction(propname, fig), contextClick: ClickFunction(propname, fig)
                    });
            }

            myDiagram.nodeTemplate.contextMenu =
                $("ContextMenu",
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            FigureButton("Rectangle"), FigureButton("RoundedRectangle"), FigureButton("Ellipse"), FigureButton("Diamond")
                        )
                    ),
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            FigureButton("Parallelogram2"), FigureButton("ManualOperation"), FigureButton("Procedure"), FigureButton("Cylinder1")
                        )
                    ),
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            FigureButton("Terminator"), FigureButton("CreateRequest"), FigureButton("Document"), FigureButton("TriangleDown")
                        )
                    ),
                    LightFillButtons(),
                    DarkColorButtons(),
                    StrokeOptionsButtons()
                );


            // Group template

            myDiagram.groupTemplate =
                $(go.Group, "Spot",
                    {
                        layerName: "Background",
                        ungroupable: true,
                        locationSpot: go.Spot.Center,
                        selectionObjectName: "BODY",
                        computesBoundsAfterDrag: true,  // allow dragging out of a Group that uses a Placeholder
                        handlesDragDropForMembers: true,  // don't need to define handlers on Nodes and Links
                        mouseDrop: (e, grp) => {  // add dropped nodes as members of the group
                            var ok = grp.addMembers(grp.diagram.selection, true);
                            if (!ok) grp.diagram.currentTool.doCancel();
                        },
                        avoidable: false
                    },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    $(go.Panel, "Auto",
                        {name: "BODY"},
                        $(go.Shape,
                            {
                                parameter1: 10,
                                fill: "white", strokeWidth: 2,
                                portId: "", cursor: "pointer",
                                fromLinkable: true, toLinkable: true,
                                fromLinkableDuplicates: true, toLinkableDuplicates: true,
                                fromSpot: go.Spot.AllSides, toSpot: go.Spot.AllSides
                            },
                            new go.Binding("fill"),
                            new go.Binding("stroke", "color"),
                            new go.Binding("strokeWidth", "thickness"),
                            new go.Binding("strokeDashArray", "dash")),
                        $(go.Placeholder,
                            {background: "transparent", margin: 10})
                    ),
                    $(go.TextBlock,
                        {
                            alignment: go.Spot.Top, alignmentFocus: go.Spot.Bottom,
                            font: "bold 30pt sans-serif", editable: true
                        },
                        new go.Binding("text"),
                        new go.Binding("stroke", "color"))
                );

            myDiagram.groupTemplate.selectionAdornmentTemplate =
                $(go.Adornment, "Spot",
                    $(go.Panel, "Auto",
                        $(go.Shape, {fill: null, stroke: "dodgerblue", strokeWidth: 3}),
                        $(go.Placeholder, {margin: 1.5})
                    ),
                    CMButton({alignment: go.Spot.TopRight, alignmentFocus: go.Spot.BottomRight})
                );

            myDiagram.groupTemplate.contextMenu =
                $("ContextMenu",
                    LightFillButtons(),
                    DarkColorButtons(),
                    StrokeOptionsButtons()
                );


            // Link template

            myDiagram.linkTemplate =
                $(go.Link,
                    {
                        layerName: "Foreground",
                        routing: go.Link.AvoidsNodes, corner: 10,
                        toShortLength: 4,  // assume arrowhead at "to" end, need to avoid bad appearance when path is thick
                        relinkableFrom: true, relinkableTo: true,
                        reshapable: true, resegmentable: true
                    },
                    new go.Binding("fromSpot", "fromSpot", go.Spot.parse),
                    new go.Binding("toSpot", "toSpot", go.Spot.parse),
                    new go.Binding("fromShortLength", "dir", dir => dir === 2 ? 4 : 0),
                    new go.Binding("toShortLength", "dir", dir => dir >= 1 ? 4 : 0),
                    new go.Binding("points").makeTwoWay(),  // TwoWay due to user reshaping with LinkReshapingTool
                    $(go.Shape, {strokeWidth: 2},
                        new go.Binding("stroke", "color"),
                        new go.Binding("strokeWidth", "thickness"),
                        new go.Binding("strokeDashArray", "dash")),
                    $(go.Shape, {fromArrow: "Backward", strokeWidth: 0, scale: 4 / 3, visible: false},
                        new go.Binding("visible", "dir", dir => dir === 2),
                        new go.Binding("fill", "color"),
                        new go.Binding("scale", "thickness", t => (2 + t) / 3)),
                    $(go.Shape, {toArrow: "Standard", strokeWidth: 0, scale: 4 / 3},
                        new go.Binding("visible", "dir", dir => dir >= 1),
                        new go.Binding("fill", "color"),
                        new go.Binding("scale", "thickness", t => (2 + t) / 3)),
                    $(go.TextBlock,
                        {alignmentFocus: new go.Spot(0, 1, -4, 0), editable: true, font: "25pt sans-serif"},
                        new go.Binding("text").makeTwoWay(),  // TwoWay due to user editing with TextEditingTool
                        new go.Binding("stroke", "color"))
                );

            myDiagram.linkTemplate.selectionAdornmentTemplate =
                $(go.Adornment,  // use a special selection Adornment that does not obscure the link path itself
                    $(go.Shape,
                        { // this uses a pathPattern with a gap in it, in order to avoid drawing on top of the link path Shape
                            isPanelMain: true,
                            stroke: "transparent", strokeWidth: 6,
                            pathPattern: makeAdornmentPathPattern(2)  // == thickness or strokeWidth
                        },
                        new go.Binding("pathPattern", "thickness", makeAdornmentPathPattern)),
                    CMButton({alignmentFocus: new go.Spot(0, 0, -6, -4)})
                );

            function makeAdornmentPathPattern(w) {
                return $(go.Shape,
                    {
                        stroke: "dodgerblue", strokeWidth: 2, strokeCap: "square",
                        geometryString: "M0 0 M4 2 H3 M4 " + (w + 4).toString() + " H3"
                    });
            }

            // Link context menu
            // All buttons in context menu work on both click and contextClick,
            // in case the user context-clicks on the button.
            // All buttons modify the link data, not the Link, so the Bindings need not be TwoWay.

            function ArrowButton(num) {
                var geo = "M0 0 M16 16 M0 8 L16 8  M12 11 L16 8 L12 5";
                if (num === 0) {
                    geo = "M0 0 M16 16 M0 8 L16 8";
                } else if (num === 2) {
                    geo = "M0 0 M16 16 M0 8 L16 8  M12 11 L16 8 L12 5  M4 11 L0 8 L4 5";
                }
                return $(go.Shape,
                    {
                        geometryString: geo,
                        margin: 2, background: "transparent",
                        mouseEnter: (e, shape) => shape.background = "dodgerblue",
                        mouseLeave: (e, shape) => shape.background = "transparent",
                        click: ClickFunction("dir", num), contextClick: ClickFunction("dir", num)
                    });
            }

            function AllSidesButton(to) {
                var setter = (e, shape) => {
                    e.handled = true;
                    e.diagram.model.commit(m => {
                        var link = shape.part.adornedPart;
                        m.set(link.data, (to ? "toSpot" : "fromSpot"), go.Spot.stringify(go.Spot.AllSides));
                        // re-spread the connections of other links connected with the node
                        (to ? link.toNode : link.fromNode).invalidateConnectedLinks();
                    });
                };
                return $(go.Shape,
                    {
                        width: 12, height: 12, fill: "transparent",
                        mouseEnter: (e, shape) => shape.background = "dodgerblue",
                        mouseLeave: (e, shape) => shape.background = "transparent",
                        click: setter, contextClick: setter
                    });
            }

            function SpotButton(spot, to) {
                var ang = 0;
                var side = go.Spot.RightSide;
                if (spot.equals(go.Spot.Top)) {
                    ang = 270;
                    side = go.Spot.TopSide;
                } else if (spot.equals(go.Spot.Left)) {
                    ang = 180;
                    side = go.Spot.LeftSide;
                } else if (spot.equals(go.Spot.Bottom)) {
                    ang = 90;
                    side = go.Spot.BottomSide;
                }
                if (!to) ang -= 180;
                var setter = (e, shape) => {
                    e.handled = true;
                    e.diagram.model.commit(m => {
                        var link = shape.part.adornedPart;
                        m.set(link.data, (to ? "toSpot" : "fromSpot"), go.Spot.stringify(side));
                        // re-spread the connections of other links connected with the node
                        (to ? link.toNode : link.fromNode).invalidateConnectedLinks();
                    });
                };
                return $(go.Shape,
                    {
                        alignment: spot, alignmentFocus: spot.opposite(),
                        geometryString: "M0 0 M12 12 M12 6 L1 6 L4 4 M1 6 L4 8",
                        angle: ang,
                        background: "transparent",
                        mouseEnter: (e, shape) => shape.background = "dodgerblue",
                        mouseLeave: (e, shape) => shape.background = "transparent",
                        click: setter, contextClick: setter
                    });
            }

            myDiagram.linkTemplate.contextMenu =
                $("ContextMenu",
                    DarkColorButtons(),
                    StrokeOptionsButtons(),
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            ArrowButton(0), ArrowButton(1), ArrowButton(2)
                        )
                    ),
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            $(go.Panel, "Spot",
                                AllSidesButton(false),
                                SpotButton(go.Spot.Top, false), SpotButton(go.Spot.Left, false), SpotButton(go.Spot.Right, false), SpotButton(go.Spot.Bottom, false)
                            ),
                            $(go.Panel, "Spot",
                                {margin: new go.Margin(0, 0, 0, 2)},
                                AllSidesButton(true),
                                SpotButton(go.Spot.Top, true), SpotButton(go.Spot.Left, true), SpotButton(go.Spot.Right, true), SpotButton(go.Spot.Bottom, true)
                            )
                        )
                    )
                );

            load();
        }

        // Show the diagram's model in JSON format
        function save() {
            var res = {};
            var j = myDiagram.model.toJson();
            console.log(j)
            document.getElementById("mySavedModel").value = j
            var nodes = JSON.parse(j).nodeDataArray
            var links = JSON.parse(j).linkDataArray
            for (let i = 0; i < nodes.length; i++) {
                if (nodes[i].key < 0) {
                    $.ajax({
                        type: 'POST',
                        dataType: "json",
                        url: "/diagram/api/v1/blocks/",
                        headers: {
                            "X-CSRFToken": '{{ csrf_token }}'
                        },
                        data: {'loc': nodes[i].loc, 'label': nodes[i].text, 'flowchart':{{flowchart_id}}},
                        success: function (data, status, xhr) {
                            res[nodes[i].key] = data.key;

                        }
                    });

                } else {
                    $.ajax({
                        type: 'PATCH',
                        dataType: "json",
                        url: "/diagram/api/v1/blocks/" + nodes[i].key + "/",
                        headers: {
                            "X-CSRFToken": '{{ csrf_token }}'
                        },
                        data: {'loc': nodes[i].loc},
                        success: function (data, status, xhr) {

                        }
                    });
                }
            }

            console.log(res)
            myDiagram.isModified = false;
        }

        function getTriggeredDate() {

            $.ajax({
                    type: 'GET',
                    dataType: "json",
                    url: "/flowchart/api/v1/flowcharts/{{ flowchart_id }}/",
                    success: function (data, status, xhr) {
                        var t = document.getElementById("triggered_date")
                        if (data.is_active) {
                            t.style.display = "block"
                            t.innerHTML = "Triggered at: " + data.p_triggered_date
                        } else {
                            t.style.display = "none"
                            t.innerHTML = ""
                        }
                    }
                }
            )
        }

        async function load() {
            await sleep(1000);
            <!-- Get Blocks -->
            $.ajax({
                type: 'GET',
                dataType: "json",
                url: '/diagram/api/v1/transitions/?flowchart_id={{ flowchart_id }}',
                success: function (data, status, xhr) {
                    linkDataArray = data;

                }
            });
            $.ajax({
                type: 'GET',
                dataType: "json",
                url: '/diagram/api/v1/blocks/?flowchart={{ flowchart_id }}',
                success: function (data, status, xhr) {
                    nodeDataArray = data;
                    totalObjects = Object.keys(nodeDataArray).length;
                    fullDataArray.nodeDataArray = nodeDataArray;
                    fullDataArray.linkDataArray = linkDataArray;
                    myDiagram.model = go.Model.fromJson(fullDataArray);
                }
            });
            var comment = document.getElementById("text-comment");
            comment.value = ""

            var labelInput = document.getElementById("label-input")
            labelInput.value = ""
            getTriggeredDate()

        }

        window.addEventListener('DOMContentLoaded', init);

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        function approveBlock(block_id) {
            $.ajax({
                type: 'PATCH',
                dataType: "json",
                url: "/diagram/api/v1/blocks/" + block_id + '/',
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                data: {'is_approved': true},
                success: function (data, status, xhr) {
                    getPreApprovedBlocks()
                    {#getActivBlock()#}
                    getActiveTransitions()
                    getComments()
                    load()
                }
            });
        }

        function approveTransition(transition_id) {
            $.ajax({
                type: 'PATCH',
                dataType: "json",
                url: "/diagram/api/v1/transitions/" + transition_id + '/',
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                data: {'is_approved': true},
                success: function (data, status, xhr) {
                    getPreApprovedBlocks()
                    {#getActivBlock()#}
                    getActiveTransitions()
                    getComments()
                    load()

                }
            });
        }

        function approveSend(block_id) {
            $.ajax({
                type: 'PATCH',
                dataType: "json",
                url: "/diagram/api/v1/blocks/" + block_id + '/',
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                data: {'is_pre_approved': true},
                success: function (data, status, xhr) {

                    sendMSG(block_id)
                    getPreApprovedBlocks()
                    {#getActivBlock()#}
                    getActiveTransitions()
                    getComments()
                    load()

                }
            });
        }

        function actionTableElement(data) {
            document.getElementById('action-table-body').innerHTML = '';
            var table = document.getElementById("action-table-body");
            var tableCard = document.getElementById('action-table-card')
            var selectBody = document.getElementById("select-body")
            selectBody.innerHTML = ""
            if (data.length === 0) {
                tableCard.style.display = "none";
            } else {

                tableCard.style.display = ""
                for (let i = 0; i < data.length; i++) {
                    var owners = ""
                    for (let j = 0; j < data[i].members.length; j++) {
                        owners = data[i].members[j].full_name + "/" + owners;
                    }
                    owners = owners.slice(0, -1)
                    var id = data[i].key
                    var tr = document.createElement('tr')
                    var td1 = document.createElement('td')
                    td1.innerHTML = data[i].text

                    var td2 = document.createElement('td')
                    td2.innerHTML = owners

                    var td3 = document.createElement('td')

                    var butt = document.createElement('button')
                    butt.classList = "btn Normal"
                    butt.style.color = 'green'
                    butt.innerHTML = "Approve"
                    butt.onclick = function () {
                        approveBlock(data[i].key)
                    }

                    var butt2 = document.createElement('button')
                    butt2.classList = "btn Normal"
                    butt2.classList.add("edit-owner-butt")
                    butt2.style.color = 'green'
                    butt2.innerHTML = "Edit"

                    td2.appendChild(butt2)

                    td3.appendChild(butt)

                    tr.appendChild(td1)
                    tr.appendChild(td2)
                    tr.appendChild(td3)

                    table.appendChild(tr)

                    var option = document.createElement('option')
                    option.value = data[i].key
                    option.innerHTML = data[i].text

                    selectBody.appendChild(option)

                }
            }
        }

        function transientTableElement(data) {
            var tableCard = document.getElementById('transient-table-card')
            if (data.length === 0) {
                tableCard.style.display = "none";
            } else {
                tableCard.style.display = "";
                document.getElementById('transient-table-body').innerHTML = '';

                var table = document.getElementById("transient-table-body");
                var tr = document.createElement('tr')
                var td1 = document.createElement('td')
                var td2 = document.createElement('td')

                var butt1 = document.createElement('button')
                var butt2 = document.createElement('button')

                butt1.classList = "btn Normal"
                butt1.style.color = 'green'
                butt1.innerHTML = data[0].text
                butt1.onclick = function () {
                    approveTransition(data[0].id)
                }
                butt2.classList = "btn Normal"
                butt2.style.color = 'green'
                butt2.innerHTML = data[1].text
                butt2.onclick = function () {
                    approveTransition(data[1].id)
                }

                td1.appendChild(butt1)
                td2.appendChild(butt2)

                tr.appendChild(td1)
                tr.appendChild(td2)
                table.appendChild(tr)
            }
        }

        function commentTableElement(data) {
            document.getElementById("comment-table-body").innerHTML = '';
            var tableBody = document.getElementById("comment-table")

            if (data.length === 0) {

                tableBody.style.display = "none";
            } else {
                tableBody.style.display = "";
                for (let i = 0; i < data.length; i++) {
                    var id = data[i].key
                    var table = document.getElementById("comment-table-body")
                    var tr = document.createElement('tr')
                    var td1 = document.createElement('td')
                    td1.innerHTML = data[i].label

                    var td2 = document.createElement('td')
                    td2.innerHTML = data[i].text

                    var td3 = document.createElement('td')

                    var td4 = document.createElement('td')
                    td4.innerHTML = data[i].last_modified

                    var td5 = document.createElement('td')
                    td5.innerHTML = data[i].author.full_name

                    var user_email = "{{ request.user.email }}"

                    var butt = document.createElement('button')
                    var butt2 = document.createElement('button')
                    if (user_email === data[i].author.email && data[i].label !== 'Email Notif') {
                        butt.classList = "btn Normal"
                        butt.style.color = 'green'
                        butt.innerHTML = "Edit"
                        butt.onclick = function () {
                            editComment(data[i].id, data[i].text, data[i].label)
                        }

                        butt2.classList = "btn Normal"
                        butt2.style.color = 'red'
                        butt2.innerHTML = "Delete"
                        butt2.onclick = function () {
                            deleteComment(data[i].id)
                        }

                    } else {
                        butt = document.createElement("p")
                        butt.innerHTML = "-"
                        butt2 = document.createElement("p")
                        butt2.innerHTML = "-"
                    }

                    td3.appendChild(butt)
                    td3.appendChild(butt2)

                    tr.appendChild(td1)
                    tr.appendChild(td2)
                    tr.appendChild(td3)
                    tr.appendChild(td4)
                    tr.appendChild(td5)

                    table.appendChild(tr)
                }
            }
        }

        function getActiveTransitions() {
            $.ajax({
                type: 'GET',
                dataType: "json",
                url: "/diagram/api/v1/transitions/?flowchart_id={{ flowchart_id }}&is_active=true",
                success: function (data, status, xhr) {
                    transientTableElement(data)
                }
            });
        }

        function getActivBlock() {
            $.ajax({
                type: 'GET',
                dataType: "json",
                url: "/diagram/api/v1/blocks/?flowchart={{ flowchart_id }}&is_active=true",
                success: function (data, status, xhr) {
                    actionTableElement(data)
                }
            });
        }

        function sendTableElement(data) {

            var selectBody = document.getElementById("select-body")
            selectBody.innerHTML = ""

            var sendTable = document.getElementById("send-table")
            sendTable.innerHTML = ""
            var temp = []

            for (let i = 0; i < data.length; i++) {

                var option = document.createElement('option')
                option.value = data[i].key
                option.innerHTML = data[i].text
                selectBody.appendChild(option)

                var textInput = document.createElement("input")
                textInput.type = "text"
                textInput.id = "msg-text"
                textInput.style.border = "1px solid black"
                textInput.style.width = "100%"
                textInput.style.textAlign = "right"
                textInput.value = data[i].text

                var button1 = document.createElement("button")
                button1.type = "button"
                button1.classList = "btn btn-outline-danger"
                button1.innerText = "Approve Send MSG"

                button1.onclick = function () {
                    approveSend(data[i].key)
                }

                var button2 = document.createElement("button")
                button2.type = "button"
                button2.classList = "btn btn-outline-success"
                button2.innerText = "Final approve"
                button2.onclick = function () {
                    approveBlock(data[i].key)
                }

                var button3 = document.createElement("button")
                button3.type = "button"
                button3.classList = "btn btn-outline-success"
                button3.innerText = "By pass"
                button3.onclick = function () {
                    byPassBlock(data[i].key)
                }

                var mainDiv = document.createElement("div")
                mainDiv.classList = "form-group"
                mainDiv.style.border = "1px solid grey"

                var h4 = document.createElement("h4")
                h4.innerText = data[i].text
                h4.style.textAlign = "center"

                mainDiv.appendChild(h4)

                var div1 = document.createElement("div")
                div1.classList = "row"

                var div2 = document.createElement("div")
                div2.classList = "col-md-9"

                var div3 = document.createElement("div")
                div3.classList = "form-group"

                if (data[i].is_pre_approved === false) {
                    var select = document.createElement("select")
                    {#select.classList = "select2 select2-hidden-accessible"#}
                    select.setAttribute("multiple", "");
                    select.setAttribute('data-placeholder', "select recipient");
                    select.style = "width: 100%"
                    select.id = "select-members-" + data[i].key.toString()

                    for (const key in data[i].members) {
                        if (data[i].members.hasOwnProperty(key)) {
                            const value = data[i].members[key]['id'];
                            temp.push(value);
                        }
                    }

                    {% for member in members %}
                        var op = document.createElement("option")
                        op.value = {{ member.id }}
                            op.innerText = "{{ member.full_name }}"
                        if (temp.includes({{ member.id }})) {
                            op.setAttribute("selected", true)
                        }
                        select.appendChild(op)

                    {% endfor %}

                    div3.appendChild(select)
                    button2.classList.add("disabled")
                    button2.setAttribute("disabled", true)

                } else {
                    button1.classList.add("disabled")
                    button1.setAttribute("disabled", true)

                    button3.classList.add("disabled")
                    button3.setAttribute("disabled", true)

                    textInput.style.display = "none"
                }
                div3.appendChild(textInput)
                div3.appendChild(button1)
                div3.appendChild(button2)
                div3.appendChild(button3)

                div2.appendChild(div3)
                div1.appendChild(div2)

                var div4 = document.createElement("div")
                div4.classList = "col-md-3"

                var div5 = document.createElement("div")
                div5.classList = "form-group"

                if (data[i].is_pre_approved === false) {
                    var select2 = document.createElement("select")
                    {#select2.classList = "select2 select2-hidden-accessible"#}
                    select2.setAttribute("multiple", "");
                    select2.setAttribute('data-placeholder', "Select MSG type");
                    select2.style = "width: 100%"
                    select2.id = "select-msg-type" + data[i].key.toString()

                    var op1 = document.createElement("option")
                    op1.value = "sms";
                    op1.innerText = "sms";
                    op1.setAttribute("selected", true)

                    var op2 = document.createElement("option")
                    op2.value = "email";
                    op2.innerText = "email";
                    op2.setAttribute("selected", true)

                    var op3 = document.createElement("option")
                    op3.value = "mm";
                    op3.innerText = "MatterMost";
                    op3.setAttribute("selected", true)

                    select2.appendChild(op1)
                    select2.appendChild(op2)
                    select2.appendChild(op3)
                    div5.appendChild(select2)
                }

                div4.appendChild(div5)

                div1.appendChild(div4)

                mainDiv.appendChild(div1)

                sendTable.appendChild(mainDiv)
            }
        }

        function getPreApprovedBlocks() {
            $.ajax({
                type: 'GET',
                dataType: "json",
                url: "/diagram/api/v1/blocks/?flowchart={{ flowchart_id }}&false&is_active=true",
                success: function (data, status, xhr) {
                    sendTableElement(data)
                }
            });
        }

        function getComments() {
            $.ajax({
                type: 'GET',
                dataType: "json",
                url: "/diagram/api/v1/comments/?flowchart_id={{ flowchart_id }}",
                success: function (data, status, xhr) {
                    commentTableElement(data)
                    var comment = document.getElementById("text-comment");
                    var labelInput = document.getElementById("label-input");
                    comment.value = ""
                    labelInput.readOnly = false;
                    labelInput.value = ""
                    var commentBtn = document.getElementById("btn_comment");
                    commentBtn.innerHTML = "submit New Comment";

                }
            });
        }

        function receivedTableElement(data) {
            document.getElementById('received-table-body').innerHTML = '';
            var table = document.getElementById("received-table-body");
            var tableCard = document.getElementById('received-table-card')
            if (data.length === 0) {
                tableCard.style.display = "none";
            } else {
                tableCard.style.display = ""
                for (let i = 0; i < data.length; i++) {

                    var user = data[i].user.email
                    var department = data[i].user.department
                    var tr = document.createElement('tr')
                    var td1 = document.createElement('td')
                    td1.innerHTML = user
                    var td2 = document.createElement('td')
                    td2.innerHTML = department
                    var td3 = document.createElement('td')
                    td3.innerHTML = "&#10003"

                    tr.appendChild(td1)
                    tr.appendChild(td2)
                    tr.appendChild(td3)

                    table.appendChild(tr)
                }
            }
        }

        function editComment(id, commentText, commentLabel) {
            var comment = document.getElementById("text-comment");
            comment.value = commentText

            var commentBtn = document.getElementById("btn_comment");
            commentBtn.innerHTML = "Edit Comment";

            var labelInput = document.getElementById("label-input")
            labelInput.value = commentLabel
            labelInput.readOnly = true

            commentId = id
        }

        function deleteComment(commentId) {

            $.ajax({
                type: 'DELETE',
                dataType: "json",
                url: "/diagram/api/v1/comments/" + commentId + "/",
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                success: function (data, status, xhr) {
                    getComments()
                }
            });
        }

        function submitComment() {
            var comment = document.getElementById("text-comment");
            var labelInput = document.getElementById("label-input");
            if (commentId != null) {
                $.ajax({
                    type: 'PATCH',
                    dataType: "json",
                    url: "/diagram/api/v1/comments/" + commentId + "/",
                    headers: {
                        "X-CSRFToken": '{{ csrf_token }}'
                    },

                    data: {'text': comment.value},
                    success: function (data, status, xhr) {
                        getComments()
                    }
                });

            } else {
                var selectBody = document.getElementById("select-body")
                $.ajax({
                    type: 'POST',
                    dataType: "json",
                    url: "/diagram/api/v1/comments/",
                    headers: {
                        "X-CSRFToken": '{{ csrf_token }}'
                    },
                    data: {'text': comment.value, 'label': labelInput.value, 'block': selectBody.value},
                    success: function (data, status, xhr) {
                        getComments()
                    }
                });
            }

            commentId = null;
        }

        function resetFlowchart() {
            $.ajax({
                type: 'POST',
                dataType: "json",
                url: "/flowchart/api/v1/flowchart-utility/",
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },

                data: {'flowchart_id': {{flowchart_id}}, 'task': 'reset'},
                success: function (data, status, xhr) {

                    getPreApprovedBlocks()
                    getActiveTransitions()
                    getComments()
                    load()
                }
            });
        }

        function endIncident() {
            $.ajax({
                type: 'POST',
                dataType: "json",
                url: "/flowchart/api/v1/flowchart-utility/",
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                data: {'flowchart_id': {{flowchart_id}}, 'task': 'end'},
                success: function (data, status, xhr) {

                    getActiveTransitions()
                    getPreApprovedBlocks()
                    getComments()
                    load()
                }
            });
        }

        function sendMSG(blockId, msg_id, members_id) {

            <!-- Save ScreenShot -->
            saveScreenShot()

            var selectedMembers = $('#select-members-' + blockId.toString()).val();
            var selectedMSG = $('#select-msg-type' + blockId.toString()).val();
            var msgText = document.getElementById("msg-text").value

            $.ajax({
                type: 'POST',
                dataType: "json",
                url: "/users/api/v1/send-msg/",
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                data: {
                    'block_id': blockId, 'msg_type': JSON.stringify(selectedMSG),
                    'members': JSON.stringify(selectedMembers),
                    'text': msgText
                },
                success: function (data, status, xhr) {
                }
            });

        }

        function byPassBlock(blockId) {
            $.ajax({
                type: 'PATCH',
                dataType: "json",
                url: "/diagram/api/v1/blocks/" + blockId + '/',
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                data: {'is_pre_approved': true},
                success: function (data, status, xhr) {
                    $.ajax({
                        type: 'PATCH',
                        dataType: "json",
                        url: "/diagram/api/v1/blocks/" + blockId + '/',
                        headers: {
                            "X-CSRFToken": '{{ csrf_token }}'
                        },
                        data: {'is_approved': true},
                        success: function (data, status, xhr) {
                            getPreApprovedBlocks()
                            getActiveTransitions()
                            getComments()
                            load()
                        }
                    });
                }
            });
        }

        getTriggeredDate()
        getPreApprovedBlocks()
        getActiveTransitions()
        getComments()

    </script>


    <script>
        function b64toBlob(b64Data, contentType, sliceSize) {
            contentType = contentType || '';
            sliceSize = sliceSize || 512;

            var byteCharacters = atob(b64Data);
            var byteArrays = [];

            for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                var slice = byteCharacters.slice(offset, offset + sliceSize);
                var byteNumbers = new Array(slice.length);
                for (var i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                var byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }

            var blob = new Blob(byteArrays, {type: contentType});
            return blob;
        }

        function saveScreenShot () {
            const screenshotTarget = document.getElementById("myDiagramDiv");
            html2canvas(screenshotTarget).then(canvas => {
                // to image as png use below line
                // const base64image = canvas.toDataURL("image/png");
                // show the image in window use below line
                // window.location.href = base64image;

                // screenshot appended to the body as canvas
                {#document.body.appendChild(canvas);#}
                image_data = canvas.toDataURL('image/png');
                // to print the screenshot in console use below line
                // console.log(dataURL);

                var block = image_data.split(";");
                var contentType = block[0].split(":")[1]
                var realData = block[1].split(",")[1];

                var blob = b64toBlob(realData, contentType);
                var formData = new FormData();
                formData.append("image", blob, '{{ flowchart_name }}.png');
                // following line is optional and it is to save the screenshot
                // on the server side. It initiates an ajax call
                pushScreenshotToServer(formData);
            });
        }

        $('#capture-screenshot').click(function () {
            const screenshotTarget = document.getElementById("myDiagramDiv");
            html2canvas(screenshotTarget).then(canvas => {
                // to image as png use below line
                // const base64image = canvas.toDataURL("image/png");
                // show the image in window use below line
                // window.location.href = base64image;

                // screenshot appended to the body as canvas
                image_data = canvas.toDataURL('image/png');
                // to print the screenshot in console use below line
                // console.log(dataURL);

                var block = image_data.split(";");
                var contentType = block[0].split(":")[1]
                var realData = block[1].split(",")[1];

                var blob = b64toBlob(realData, contentType);
                var formData = new FormData();
                formData.append("image", blob, '{{ flowchart_name }}.png');
                // following line is optional and it is to save the screenshot
                // on the server side. It initiates an ajax call
                pushScreenshotToServer(formData);
            });
        });


        function pushScreenshotToServer(formData) {
            $.ajax({
                url: "/flowchart/api/v1/screenshot/",
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                type: "POST",
                timeout: 0,
                processData: false,
                mimeType: "multipart/form-data",
                contentType: false,
                data: formData,
                dataType: "json",
                success: function () {
                    console.log('Screenshot pushed to server.');
                }
            });
        }
    </script>

{% endblock %}

