{% extends 'base/base.html' %}
{% load static %}
{% block title %} Flowchart {% endblock %}

{% block head %}
    <script src="{% static 'js/go.js' %}"></script>
    <script src="{% static 'js/DrawCommandHandler.js' %}"></script>
    <script src="{% static 'js/figures.js' %}"></script>


    <script id="code">
        var nodeDataArray = {};
        var linkDataArray = {};
        var fullDataArray = {};
        var totalObjects = null;
        var commentId = null


        function init() {

            // Since 2.2 you can also author concise templates with method chaining instead of GraphObject.make
            // For details, see https://gojs.net/latest/intro/buildingObjects.html
            const $ = go.GraphObject.make;
            myDiagram =
                $(go.Diagram, "myDiagramDiv",
                    {
                        autoScale: go.Diagram.Uniform,
                        padding: 10,  // extra space when scrolled all the way
                        "draggingTool.isGridSnapEnabled": true,
                        handlesDragDropForTopLevelParts: true,
                        mouseDrop: e => {
                            // when the selection is dropped in the diagram's background,
                            // make sure the selected Parts no longer belong to any Group
                            var ok = e.diagram.commandHandler.addTopLevelParts(e.diagram.selection, true);
                            if (!ok) e.diagram.currentTool.doCancel();
                        },
                        commandHandler: $(DrawCommandHandler),  // support offset copy-and-paste
                        "clickCreatingTool.archetypeNodeData": {text: "NEW NODE"},  // create a new node by double-clicking in background
                        "PartCreated": e => {
                            var node = e.subject;  // the newly inserted Node -- now need to snap its location to the grid
                            node.location = node.location.copy().snapToGridPoint(e.diagram.grid.gridOrigin, e.diagram.grid.gridCellSize);
                            setTimeout(() => {  // and have the user start editing its text
                                e.diagram.commandHandler.editTextBlock();
                            }, 20);
                        },
                        "commandHandler.archetypeGroupData": {isGroup: true, text: "NEW GROUP"},
                        "SelectionGrouped": e => {
                            var group = e.subject;
                            setTimeout(() => {  // and have the user start editing its text
                                e.diagram.commandHandler.editTextBlock();
                            })
                        },
                        "LinkRelinked": e => {
                            // re-spread the connections of other links connected with both old and new nodes
                            var oldnode = e.parameter.part;
                            oldnode.invalidateConnectedLinks();
                            var link = e.subject;
                            if (e.diagram.toolManager.linkingTool.isForwards) {
                                link.toNode.invalidateConnectedLinks();
                            } else {
                                link.fromNode.invalidateConnectedLinks();
                            }
                        },
                        "undoManager.isEnabled": true
                    });


            // Node template

            myDiagram.nodeTemplate =
                $(go.Node, "Auto",
                    {
                        locationSpot: go.Spot.Center, locationObjectName: "SHAPE",
                        desiredSize: new go.Size(120, 60), minSize: new go.Size(40, 40),
                        resizable: true, resizeCellSize: new go.Size(20, 20)
                    },
                    // these Bindings are TwoWay because the DraggingTool and ResizingTool modify the target properties
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    new go.Binding("desiredSize", "size", go.Size.parse).makeTwoWay(go.Size.stringify),
                    $(go.Shape,
                        { // the border
                            name: "SHAPE", fill: "white",
                            portId: "", cursor: "pointer",
                            fromLinkable: true, toLinkable: true,
                            fromLinkableDuplicates: true, toLinkableDuplicates: true,
                            fromSpot: go.Spot.AllSides, toSpot: go.Spot.AllSides
                        },
                        new go.Binding("figure"),
                        new go.Binding("fill"),
                        new go.Binding("stroke", "color"),
                        new go.Binding("strokeWidth", "thickness"),
                        new go.Binding("strokeDashArray", "dash")),
                    // this Shape prevents mouse events from reaching the middle of the port
                    $(go.Shape, {width: 100, height: 40, strokeWidth: 0, fill: "transparent"}),
                    $(go.TextBlock,
                        {
                            margin: 1,
                            textAlign: "center",
                            overflow: go.TextBlock.OverflowEllipsis,
                            editable: true,
                            font: "25pt sans-serif"
                        },
                        // this Binding is TwoWay due to the user editing the text with the TextEditingTool
                        new go.Binding("text").makeTwoWay(),
                        new go.Binding("stroke", "color"))
                );

            myDiagram.nodeTemplate.toolTip =
                $("ToolTip",  // show some detailed information
                    $(go.Panel, "Vertical",
                        {maxSize: new go.Size(200, NaN)},  // limit width but not height
                        $(go.TextBlock,
                            {font: "25pt sans-serif", textAlign: "center"},
                            new go.Binding("text")),
                        $(go.TextBlock,
                            {font: "25pt sans-serif", textAlign: "center"},
                            new go.Binding("text", "details"))
                    )
                );

            // Node selection adornment
            // Include four large triangular buttons so that the user can easily make a copy
            // of the node, move it to be in that direction relative to the original node,
            // and add a link to the new node.

            function makeArrowButton(spot, fig) {
                var maker = (e, shape) => {
                    e.handled = true;
                    e.diagram.model.commit(m => {
                        var selnode = shape.part.adornedPart;
                        // create a new node in the direction of the spot
                        var p = new go.Point().setRectSpot(selnode.actualBounds, spot);
                        p.subtract(selnode.location);
                        p.scale(2, 2);
                        p.x += Math.sign(p.x) * 60;
                        p.y += Math.sign(p.y) * 60;
                        p.add(selnode.location);
                        p.snapToGridPoint(e.diagram.grid.gridOrigin, e.diagram.grid.gridCellSize);
                        // make the new node a copy of the selected node
                        var nodedata = m.copyNodeData(selnode.data);
                        // add to same group as selected node
                        m.setGroupKeyForNodeData(nodedata, m.getGroupKeyForNodeData(selnode.data));
                        m.addNodeData(nodedata);  // add to model
                        // create a link from the selected node to the new node
                        var linkdata = {from: selnode.key, to: m.getKeyForNodeData(nodedata)};
                        m.addLinkData(linkdata);  // add to model
                        // move the new node to the computed location, select it, and start to edit it
                        var newnode = e.diagram.findNodeForData(nodedata);
                        newnode.location = p;
                        e.diagram.select(newnode);
                        setTimeout(() => {
                            e.diagram.commandHandler.editTextBlock();
                        }, 20);
                    });
                };
                return $(go.Shape,
                    {
                        figure: fig,
                        alignment: spot, alignmentFocus: spot.opposite(),
                        width: (spot.equals(go.Spot.Top) || spot.equals(go.Spot.Bottom)) ? 36 : 18,
                        height: (spot.equals(go.Spot.Top) || spot.equals(go.Spot.Bottom)) ? 18 : 36,
                        fill: "orange", strokeWidth: 0,
                        isActionable: true,  // needed because it's in an Adornment
                        click: maker, contextClick: maker
                    });
            }

            // create a button that brings up the context menu
            function CMButton(options) {
                return $(go.Shape,
                    {
                        fill: "orange", stroke: "gray", background: "transparent",
                        geometryString: "F1 M0 0 M0 4h4v4h-4z M6 4h4v4h-4z M12 4h4v4h-4z M0 12",
                        isActionable: true, cursor: "context-menu",
                        click: (e, shape) => {
                            e.diagram.commandHandler.showContextMenu(shape.part.adornedPart);
                        }
                    },
                    options || {});
            }

            myDiagram.nodeTemplate.selectionAdornmentTemplate =
                $(go.Adornment, "Spot",
                    $(go.Placeholder, {padding: 10}),
                    makeArrowButton(go.Spot.Top, "TriangleUp"),
                    makeArrowButton(go.Spot.Left, "TriangleLeft"),
                    makeArrowButton(go.Spot.Right, "TriangleRight"),
                    makeArrowButton(go.Spot.Bottom, "TriangleDown"),
                    CMButton({alignment: new go.Spot(0.75, 0)})
                );

            // Common context menu button definitions

            // All buttons in context menu work on both click and contextClick,
            // in case the user context-clicks on the button.
            // All buttons modify the node data, not the Node, so the Bindings need not be TwoWay.

            // A button-defining helper function that returns a click event handler.
            // PROPNAME is the name of the data property that should be set to the given VALUE.
            function ClickFunction(propname, value) {
                return (e, obj) => {
                    e.handled = true;  // don't let the click bubble up
                    e.diagram.model.commit(m => {
                        m.set(obj.part.adornedPart.data, propname, value);
                    });
                };
            }

            // Create a context menu button for setting a data property with a color value.
            function ColorButton(color, propname) {
                if (!propname) propname = "color";
                return $(go.Shape,
                    {
                        width: 16, height: 16, stroke: "lightgray", fill: color,
                        margin: 1, background: "transparent",
                        mouseEnter: (e, shape) => shape.stroke = "dodgerblue",
                        mouseLeave: (e, shape) => shape.stroke = "lightgray",
                        click: ClickFunction(propname, color), contextClick: ClickFunction(propname, color)
                    });
            }

            function LightFillButtons() {  // used by multiple context menus
                return [
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            ColorButton("white", "fill"), ColorButton("beige", "fill"), ColorButton("aliceblue", "fill"), ColorButton("lightyellow", "fill")
                        )
                    ),
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            ColorButton("lightgray", "fill"), ColorButton("lightgreen", "fill"), ColorButton("lightblue", "fill"), ColorButton("pink", "fill")
                        )
                    )
                ];
            }

            function DarkColorButtons() {  // used by multiple context menus
                return [
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            ColorButton("black"), ColorButton("green"), ColorButton("blue"), ColorButton("red")
                        )
                    ),
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            ColorButton("brown"), ColorButton("magenta"), ColorButton("purple"), ColorButton("orange")
                        )
                    )
                ];
            }

            // Create a context menu button for setting a data property with a stroke width value.
            function ThicknessButton(sw, propname) {
                if (!propname) propname = "thickness";
                return $(go.Shape, "LineH",
                    {
                        width: 16, height: 16, strokeWidth: sw,
                        margin: 1, background: "transparent",
                        mouseEnter: (e, shape) => shape.background = "dodgerblue",
                        mouseLeave: (e, shape) => shape.background = "transparent",
                        click: ClickFunction(propname, sw), contextClick: ClickFunction(propname, sw)
                    });
            }

            // Create a context menu button for setting a data property with a stroke dash Array value.
            function DashButton(dash, propname) {
                if (!propname) propname = "dash";
                return $(go.Shape, "LineH",
                    {
                        width: 24, height: 16, strokeWidth: 2,
                        strokeDashArray: dash,
                        margin: 1, background: "transparent",
                        mouseEnter: (e, shape) => shape.background = "dodgerblue",
                        mouseLeave: (e, shape) => shape.background = "transparent",
                        click: ClickFunction(propname, dash), contextClick: ClickFunction(propname, dash)
                    });
            }

            function StrokeOptionsButtons() {  // used by multiple context menus
                return [
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            ThicknessButton(1), ThicknessButton(2), ThicknessButton(3), ThicknessButton(4)
                        )
                    ),
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            DashButton(null), DashButton([2, 4]), DashButton([4, 4])
                        )
                    )
                ];
            }

            // Node context menu

            function FigureButton(fig, propname) {
                if (!propname) propname = "figure";
                return $(go.Shape,
                    {
                        width: 32, height: 32, scale: 0.5, fill: "lightgray", figure: fig,
                        margin: 1, background: "transparent",
                        mouseEnter: (e, shape) => shape.fill = "dodgerblue",
                        mouseLeave: (e, shape) => shape.fill = "lightgray",
                        click: ClickFunction(propname, fig), contextClick: ClickFunction(propname, fig)
                    });
            }

            myDiagram.nodeTemplate.contextMenu =
                $("ContextMenu",
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            FigureButton("Rectangle"), FigureButton("RoundedRectangle"), FigureButton("Ellipse"), FigureButton("Diamond")
                        )
                    ),
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            FigureButton("Parallelogram2"), FigureButton("ManualOperation"), FigureButton("Procedure"), FigureButton("Cylinder1")
                        )
                    ),
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            FigureButton("Terminator"), FigureButton("CreateRequest"), FigureButton("Document"), FigureButton("TriangleDown")
                        )
                    ),
                    LightFillButtons(),
                    DarkColorButtons(),
                    StrokeOptionsButtons()
                );


            // Group template

            myDiagram.groupTemplate =
                $(go.Group, "Spot",
                    {
                        layerName: "Background",
                        ungroupable: true,
                        locationSpot: go.Spot.Center,
                        selectionObjectName: "BODY",
                        computesBoundsAfterDrag: true,  // allow dragging out of a Group that uses a Placeholder
                        handlesDragDropForMembers: true,  // don't need to define handlers on Nodes and Links
                        mouseDrop: (e, grp) => {  // add dropped nodes as members of the group
                            var ok = grp.addMembers(grp.diagram.selection, true);
                            if (!ok) grp.diagram.currentTool.doCancel();
                        },
                        avoidable: false
                    },
                    new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
                    $(go.Panel, "Auto",
                        {name: "BODY"},
                        $(go.Shape,
                            {
                                parameter1: 10,
                                fill: "white", strokeWidth: 2,
                                portId: "", cursor: "pointer",
                                fromLinkable: true, toLinkable: true,
                                fromLinkableDuplicates: true, toLinkableDuplicates: true,
                                fromSpot: go.Spot.AllSides, toSpot: go.Spot.AllSides
                            },
                            new go.Binding("fill"),
                            new go.Binding("stroke", "color"),
                            new go.Binding("strokeWidth", "thickness"),
                            new go.Binding("strokeDashArray", "dash")),
                        $(go.Placeholder,
                            {background: "transparent", margin: 10})
                    ),
                    $(go.TextBlock,
                        {
                            alignment: go.Spot.Top, alignmentFocus: go.Spot.Bottom,
                            font: "bold 30pt sans-serif", editable: true
                        },
                        new go.Binding("text"),
                        new go.Binding("stroke", "color"))
                );

            myDiagram.groupTemplate.selectionAdornmentTemplate =
                $(go.Adornment, "Spot",
                    $(go.Panel, "Auto",
                        $(go.Shape, {fill: null, stroke: "dodgerblue", strokeWidth: 3}),
                        $(go.Placeholder, {margin: 1.5})
                    ),
                    CMButton({alignment: go.Spot.TopRight, alignmentFocus: go.Spot.BottomRight})
                );

            myDiagram.groupTemplate.contextMenu =
                $("ContextMenu",
                    LightFillButtons(),
                    DarkColorButtons(),
                    StrokeOptionsButtons()
                );


            // Link template

            myDiagram.linkTemplate =
                $(go.Link,
                    {
                        layerName: "Foreground",
                        routing: go.Link.AvoidsNodes, corner: 10,
                        toShortLength: 4,  // assume arrowhead at "to" end, need to avoid bad appearance when path is thick
                        relinkableFrom: true, relinkableTo: true,
                        reshapable: true, resegmentable: true
                    },
                    new go.Binding("fromSpot", "fromSpot", go.Spot.parse),
                    new go.Binding("toSpot", "toSpot", go.Spot.parse),
                    new go.Binding("fromShortLength", "dir", dir => dir === 2 ? 4 : 0),
                    new go.Binding("toShortLength", "dir", dir => dir >= 1 ? 4 : 0),
                    new go.Binding("points").makeTwoWay(),  // TwoWay due to user reshaping with LinkReshapingTool
                    $(go.Shape, {strokeWidth: 2},
                        new go.Binding("stroke", "color"),
                        new go.Binding("strokeWidth", "thickness"),
                        new go.Binding("strokeDashArray", "dash")),
                    $(go.Shape, {fromArrow: "Backward", strokeWidth: 0, scale: 4 / 3, visible: false},
                        new go.Binding("visible", "dir", dir => dir === 2),
                        new go.Binding("fill", "color"),
                        new go.Binding("scale", "thickness", t => (2 + t) / 3)),
                    $(go.Shape, {toArrow: "Standard", strokeWidth: 0, scale: 4 / 3},
                        new go.Binding("visible", "dir", dir => dir >= 1),
                        new go.Binding("fill", "color"),
                        new go.Binding("scale", "thickness", t => (2 + t) / 3)),
                    $(go.TextBlock,
                        {alignmentFocus: new go.Spot(0, 1, -4, 0), editable: true, font: "25pt sans-serif"},
                        new go.Binding("text").makeTwoWay(),  // TwoWay due to user editing with TextEditingTool
                        new go.Binding("stroke", "color"))
                );

            myDiagram.linkTemplate.selectionAdornmentTemplate =
                $(go.Adornment,  // use a special selection Adornment that does not obscure the link path itself
                    $(go.Shape,
                        { // this uses a pathPattern with a gap in it, in order to avoid drawing on top of the link path Shape
                            isPanelMain: true,
                            stroke: "transparent", strokeWidth: 6,
                            pathPattern: makeAdornmentPathPattern(2)  // == thickness or strokeWidth
                        },
                        new go.Binding("pathPattern", "thickness", makeAdornmentPathPattern)),
                    CMButton({alignmentFocus: new go.Spot(0, 0, -6, -4)})
                );

            function makeAdornmentPathPattern(w) {
                return $(go.Shape,
                    {
                        stroke: "dodgerblue", strokeWidth: 2, strokeCap: "square",
                        geometryString: "M0 0 M4 2 H3 M4 " + (w + 4).toString() + " H3"
                    });
            }

            // Link context menu
            // All buttons in context menu work on both click and contextClick,
            // in case the user context-clicks on the button.
            // All buttons modify the link data, not the Link, so the Bindings need not be TwoWay.

            function ArrowButton(num) {
                var geo = "M0 0 M16 16 M0 8 L16 8  M12 11 L16 8 L12 5";
                if (num === 0) {
                    geo = "M0 0 M16 16 M0 8 L16 8";
                } else if (num === 2) {
                    geo = "M0 0 M16 16 M0 8 L16 8  M12 11 L16 8 L12 5  M4 11 L0 8 L4 5";
                }
                return $(go.Shape,
                    {
                        geometryString: geo,
                        margin: 2, background: "transparent",
                        mouseEnter: (e, shape) => shape.background = "dodgerblue",
                        mouseLeave: (e, shape) => shape.background = "transparent",
                        click: ClickFunction("dir", num), contextClick: ClickFunction("dir", num)
                    });
            }

            function AllSidesButton(to) {
                var setter = (e, shape) => {
                    e.handled = true;
                    e.diagram.model.commit(m => {
                        var link = shape.part.adornedPart;
                        m.set(link.data, (to ? "toSpot" : "fromSpot"), go.Spot.stringify(go.Spot.AllSides));
                        // re-spread the connections of other links connected with the node
                        (to ? link.toNode : link.fromNode).invalidateConnectedLinks();
                    });
                };
                return $(go.Shape,
                    {
                        width: 12, height: 12, fill: "transparent",
                        mouseEnter: (e, shape) => shape.background = "dodgerblue",
                        mouseLeave: (e, shape) => shape.background = "transparent",
                        click: setter, contextClick: setter
                    });
            }

            function SpotButton(spot, to) {
                var ang = 0;
                var side = go.Spot.RightSide;
                if (spot.equals(go.Spot.Top)) {
                    ang = 270;
                    side = go.Spot.TopSide;
                } else if (spot.equals(go.Spot.Left)) {
                    ang = 180;
                    side = go.Spot.LeftSide;
                } else if (spot.equals(go.Spot.Bottom)) {
                    ang = 90;
                    side = go.Spot.BottomSide;
                }
                if (!to) ang -= 180;
                var setter = (e, shape) => {
                    e.handled = true;
                    e.diagram.model.commit(m => {
                        var link = shape.part.adornedPart;
                        m.set(link.data, (to ? "toSpot" : "fromSpot"), go.Spot.stringify(side));
                        // re-spread the connections of other links connected with the node
                        (to ? link.toNode : link.fromNode).invalidateConnectedLinks();
                    });
                };
                return $(go.Shape,
                    {
                        alignment: spot, alignmentFocus: spot.opposite(),
                        geometryString: "M0 0 M12 12 M12 6 L1 6 L4 4 M1 6 L4 8",
                        angle: ang,
                        background: "transparent",
                        mouseEnter: (e, shape) => shape.background = "dodgerblue",
                        mouseLeave: (e, shape) => shape.background = "transparent",
                        click: setter, contextClick: setter
                    });
            }

            myDiagram.linkTemplate.contextMenu =
                $("ContextMenu",
                    DarkColorButtons(),
                    StrokeOptionsButtons(),
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            ArrowButton(0), ArrowButton(1), ArrowButton(2)
                        )
                    ),
                    $("ContextMenuButton",
                        $(go.Panel, "Horizontal",
                            $(go.Panel, "Spot",
                                AllSidesButton(false),
                                SpotButton(go.Spot.Top, false), SpotButton(go.Spot.Left, false), SpotButton(go.Spot.Right, false), SpotButton(go.Spot.Bottom, false)
                            ),
                            $(go.Panel, "Spot",
                                {margin: new go.Margin(0, 0, 0, 2)},
                                AllSidesButton(true),
                                SpotButton(go.Spot.Top, true), SpotButton(go.Spot.Left, true), SpotButton(go.Spot.Right, true), SpotButton(go.Spot.Bottom, true)
                            )
                        )
                    )
                );

            load();
        }

        // Show the diagram's model in JSON format
        function save() {
            document.getElementById("mySavedModel").value = myDiagram.model.toJson()


            myDiagram.isModified = false;
        }

        function load() {
            <!-- Get Blocks -->
            $.ajax({
                type: 'GET',
                dataType: "json",
                url: '/diagram/api/v1/blocks/?flowchart={{ flowchart_id }}',
                success: function (data, status, xhr) {
                    nodeDataArray = data;
                    totalObjects = Object.keys(nodeDataArray).length;
                }
            });
            <!-- Get Transitions -->
            $.ajax({
                type: 'GET',
                dataType: "json",
                url: '/diagram/api/v1/transitions/?flowchart={{ flowchart_id }}',
                success: function (data, status, xhr) {
                    linkDataArray = data;
                    fullDataArray.nodeDataArray = nodeDataArray;
                    fullDataArray.linkDataArray = linkDataArray;

                    myDiagram.model = go.Model.fromJson(fullDataArray);
                }
            });
            var comment = document.getElementById("text-comment");
            comment.value = ""

            var labelInput = document.getElementById("label-input")
            labelInput.value = ""

        }

        window.addEventListener('DOMContentLoaded', init);

        function approveBlock(block_id) {
            var token = document.getElementsByName("csrfToken").value;
            $.ajax({
                type: 'PATCH',
                dataType: "json",
                url: "/diagram/api/v1/blocks/" + block_id + '/',
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                data: {'is_approved': true},
                success: function (data, status, xhr) {

                    getActivBlock()
                    getActiveTransitions()
                    getComments()
                    load()

                }
            });
        }

        function approveTransition(transition_id) {
            $.ajax({
                type: 'PATCH',
                dataType: "json",
                url: "/diagram/api/v1/transitions/" + transition_id + '/',
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                data: {'is_approved': true},
                success: function (data, status, xhr) {
                    getActivBlock()
                    getActiveTransitions()
                    load()

                }
            });
        }

        function actionTableElement(data) {
            document.getElementById('action-table-body').innerHTML = '';
            var table = document.getElementById("action-table-body");
            var tableCard = document.getElementById('action-table-card')
            var selectBody = document.getElementById("select-body")
            selectBody.innerHTML = ""
            if (data.length === 0) {
                tableCard.style.display = "none";
            } else {

                tableCard.style.display = ""
                for (let i = 0; i < data.length; i++) {
                    var owners = ""
                    for (let j = 0; j < data[i].user_groups.length; j++) {
                        owners = data[i].user_groups[j].name + "/" + owners;
                    }
                    owners = owners.slice(0, -1)
                    var id = data[i].key
                    var tr = document.createElement('tr')
                    var td1 = document.createElement('td')
                    td1.innerHTML = data[i].text

                    var td2 = document.createElement('td')
                    td2.innerHTML = owners

                    var td3 = document.createElement('td')

                    var butt = document.createElement('button')
                    butt.classList = "btn Normal"
                    butt.style.color = 'green'
                    butt.innerHTML = "Approve"
                    butt.onclick = function () {
                        approveBlock(data[i].key)
                    }

                    var butt2 = document.createElement('button')
                    butt2.classList = "btn Normal"
                    butt2.classList.add("edit-owner-butt")
                    butt2.style.color = 'green'
                    butt2.innerHTML = "Edit"

                    td2.appendChild(butt2)

                    td3.appendChild(butt)

                    tr.appendChild(td1)
                    tr.appendChild(td2)
                    tr.appendChild(td3)

                    table.appendChild(tr)

                    var option = document.createElement('option')
                    option.value = data[i].key
                    option.innerHTML = data[i].text

                    selectBody.appendChild(option)

                }
            }
        }

        function transientTableElement(data) {
            var tableCard = document.getElementById('transient-table-card')
            if (data.length === 0) {
                tableCard.style.display = "none";
            } else {
                tableCard.style.display = "";
                document.getElementById('transient-table-body').innerHTML = '';

                var table = document.getElementById("transient-table-body");
                var tr = document.createElement('tr')
                var td1 = document.createElement('td')
                var td2 = document.createElement('td')

                var butt1 = document.createElement('button')
                var butt2 = document.createElement('button')

                butt1.classList = "btn Normal"
                butt1.style.color = 'green'
                butt1.innerHTML = data[0].text
                butt1.onclick = function () {
                    approveTransition(data[0].id)
                }
                butt2.classList = "btn Normal"
                butt2.style.color = 'green'
                butt2.innerHTML = data[1].text
                butt2.onclick = function () {
                    approveTransition(data[1].id)
                }

                td1.appendChild(butt1)
                td2.appendChild(butt2)

                tr.appendChild(td1)
                tr.appendChild(td2)
                table.appendChild(tr)
            }
        }

        function commentTableElement(data) {
            document.getElementById("comment-table-body").innerHTML = '';
            var tableBody = document.getElementById("comment-table")

            if (data.length === 0) {

                tableBody.style.display = "none";
            } else {
                tableBody.style.display = "";
                for (let i = 0; i < data.length; i++) {
                    var id = data[i].key
                    var table = document.getElementById("comment-table-body")
                    var tr = document.createElement('tr')
                    var td1 = document.createElement('td')
                    td1.innerHTML = data[i].label

                    var td2 = document.createElement('td')
                    td2.innerHTML = data[i].text

                    var td3 = document.createElement('td')

                    var td4 = document.createElement('td')
                    td4.innerHTML = data[i].last_modified

                    var td5 = document.createElement('td')
                    td5.innerHTML = data[i].author.full_name

                    var user_email = "{{ request.user.email }}"

                    var butt = document.createElement('button')
                    var butt2 = document.createElement('button')
                    if (user_email === data[i].author.email && data[i].label !== 'Email Notif') {
                        butt.classList = "btn Normal"
                        butt.style.color = 'green'
                        butt.innerHTML = "Edit"
                        butt.onclick = function () {
                            editComment(data[i].id, data[i].text, data[i].label)
                        }

                        butt2.classList = "btn Normal"
                        butt2.style.color = 'red'
                        butt2.innerHTML = "Delete"
                        butt2.onclick = function () {
                            deleteComment(data[i].id)
                        }

                    } else {
                        butt = document.createElement("p")
                        butt.innerHTML = "-"
                        butt2 = document.createElement("p")
                        butt2.innerHTML = "-"

                    }

                    td3.appendChild(butt)
                    td3.appendChild(butt2)

                    tr.appendChild(td1)
                    tr.appendChild(td2)
                    tr.appendChild(td3)
                    tr.appendChild(td4)
                    tr.appendChild(td5)

                    table.appendChild(tr)
                }
            }
        }

        function getActiveTransitions() {
            $.ajax({
                type: 'GET',
                dataType: "json",
                url: "/diagram/api/v1/active_transitions/{{ flowchart_id }}",
                success: function (data, status, xhr) {
                    transientTableElement(data)
                }
            });

        }

        function getActivBlock() {
            $.ajax({
                type: 'GET',
                dataType: "json",
                url: "/diagram/api/v1/active_blocks/{{ flowchart_id }}",
                success: function (data, status, xhr) {
                    actionTableElement(data)
                }
            });
        }

        function getComments() {
            $.ajax({
                type: 'GET',
                dataType: "json",
                url: "/diagram/api/v1/comments/?flowchart_id={{ flowchart_id }}",
                success: function (data, status, xhr) {
                    commentTableElement(data)
                    var comment = document.getElementById("text-comment");
                    var labelInput = document.getElementById("label-input");
                    comment.value = ""
                    labelInput.readOnly = false;
                    labelInput.value = ""
                    var commentBtn = document.getElementById("btn_comment");
                    commentBtn.innerHTML = "submit New Comment";


                }
            });
        }

        function receivedTableElement(data) {
            document.getElementById('received-table-body').innerHTML = '';
            var table = document.getElementById("received-table-body");
            var tableCard = document.getElementById('received-table-card')
            if (data.length === 0) {
                tableCard.style.display = "none";
            } else {
                tableCard.style.display = ""
                for (let i = 0; i < data.length; i++) {

                    var user = data[i].user.email
                    var department = data[i].user.department
                    var tr = document.createElement('tr')
                    var td1 = document.createElement('td')
                    td1.innerHTML = user
                    var td2 = document.createElement('td')
                    td2.innerHTML = department
                    var td3 = document.createElement('td')
                    td3.innerHTML = "&#10003"

                    tr.appendChild(td1)
                    tr.appendChild(td2)
                    tr.appendChild(td3)

                    table.appendChild(tr)
                }
            }
        }

        getActivBlock()
        getActiveTransitions()
        getComments()

        function editComment(id, commentText, commentLabel) {
            var comment = document.getElementById("text-comment");
            comment.value = commentText

            var commentBtn = document.getElementById("btn_comment");
            commentBtn.innerHTML = "Edit Comment";

            var labelInput = document.getElementById("label-input")
            labelInput.value = commentLabel
            labelInput.readOnly = true

            commentId = id
        }

        function deleteComment(commentId) {

            $.ajax({
                type: 'DELETE',
                dataType: "json",
                url: "/diagram/api/v1/comments/" + commentId + "/",
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                success: function (data, status, xhr) {
                    getComments()
                }
            });

        }

        function submitComment() {
            var comment = document.getElementById("text-comment");
            var labelInput = document.getElementById("label-input");
            if (commentId != null) {
                $.ajax({
                    type: 'PATCH',
                    dataType: "json",
                    url: "/diagram/api/v1/comments/" + commentId + "/",
                    headers: {
                        "X-CSRFToken": '{{ csrf_token }}'
                    },

                    data: {'text': comment.value},
                    success: function (data, status, xhr) {
                        getComments()
                    }
                });

            } else {
                var selectBody = document.getElementById("select-body")
                $.ajax({
                    type: 'POST',
                    dataType: "json",
                    url: "/diagram/api/v1/comments/",
                    headers: {
                        "X-CSRFToken": '{{ csrf_token }}'
                    },
                    data: {'text': comment.value, 'label': labelInput.value, 'block': selectBody.value},
                    success: function (data, status, xhr) {
                        getComments()
                    }
                });
            }

            commentId = null;
        }

        function editOwners() {
            var ownerDiv = document.getElementById("edit-owner")
            ownerDiv.style.display = "block"
        }

        function resetFlowchart() {
            $.ajax({
                type: 'POST',
                dataType: "json",
                url: "/flowchart/api/v1/reset-flowchart/",
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },

                data: {'flowchart_id': {{flowchart_id}}},
                success: function (data, status, xhr) {
                    load();
                    getActivBlock()
                    getActiveTransitions()
                }
            });
        }


    </script>


{% endblock %}

{% block dashboard %} {{ flowchart_name }} {% endblock %}

{% block content %}
    <!-- for CSRF Token -->
    <form method="post" id="myForm" action="">
        <input name="csrfToken" value="5965f0d244b7d32b334eff840...etc" type="hidden">
    </form>

    <div id="sample">
    <div id="myDiagramDiv"
         style="border: 1px solid black; background-color: rgb(255, 255, 255); width: 100%; height: 800px; position: relative; cursor: auto;">
        <canvas tabindex="0"
                style="position: absolute; top: 10px; left: 0px;  z-index: 2; user-select: none; touch-action: none; width: 1054px; height: 598px; cursor: auto;"
                width="1054" height="598">This text is displayed if your browser does not support the Canvas HTML
            element.
        </canvas>
        <div style="position: absolute; overflow: auto; width: 1054px; height: 598px; z-index: 1;">
            <div style="position: absolute; width: 1px; height: 1px;"></div>
        </div>
    </div>

    <button class="button" id="loadModel" onclick="load()">Load</button>
    {#        <button id="saveModel" onclick="save()">Save</button>#}

    <div style="text-align: center; height: 50px">
        <button type="button" class="btn btn-primary" onclick="resetFlowchart()">Reset Flowchart</button>
    </div>


    <!-- Actions Card --->
    <div class="card" id="action-table-card">
        <div style="background-color: #BD1E51; text-align: center" class="card-header">
            <h4 style="color: white">Active Actions</h4>
        </div>

        <div class="card-body">
            <table id="action-table" class="table table-bordered table-striped" style="text-align: center">
                <thead>
                <tr>
                    <th>Incident Name</th>
                    <th>Owners</th>
                    <th>Action</th>
                </tr>
                </thead>
                <tbody id="action-table-body">
                <tr>
                    <td>Trident</td>
                    <td>Win 95+</td>
                    <td>
                        <button class="btn Normal" style="background-color: greenyellow"> Approve</button>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>


    <!-- Transitions Card --->
    <div class="card" id="transient-table-card">
        <div style="background-color: #BD1E51; text-align: center" class="card-header">
            <h4 style="color: white">Choose Path</h4>
        </div>

        <div class="card-body">
            <table id="transient-table" class="table table-bordered table-striped" style="text-align: center">
                <thead>
                <tr>
                    <th>PATH 1</th>
                    <th>PATH 2</th>
                </tr>
                </thead>
                <tbody id="transient-table-body">

                </tbody>
            </table>
        </div>
    </div>


    <!-- comment Card --->
    <div class="card">
        <div style="background-color: #BD1E51;text-align: center" class="card-header">
            <h4 style="color: white">Comments and Messages</h4>
        </div>

        <div class="card-body">
            <table id="comment-table" class="table table-bordered table-striped" style="text-align: center">
                <thead>
                <tr>
                    <th>Subject</th>
                    <th>Description</th>
                    <th>Action</th>
                    <th>Updated Date</th>
                    <th>User</th>
                </tr>
                </thead>
                <tbody id="comment-table-body">

                </tbody>
            </table>
        </div>
        <div class="card-body">
            <div class="col">


                <div class="form-group">
                    <label>Subject: </label>
                    <input type="text" class="form-control" id="label-input" placeholder="Enter subject"
                           style="margin: 0!important;border: 1px solid black!important;">
                </div>


                <div class="col-md-6" data-select2-id="29">
                    <div class="form-group">
                        <label>Choose Action: </label>
                        <select class="form-control select2 select2-hidden-accessible"
                                style="width: 100%; border: 1px solid black!important"
                                data-select2-id="1" tabindex="-1" aria-hidden="true" id="select-body">
                        </select>
                    </div>
                    <!-- /.form-group -->
                </div>
                <textarea class="form-control bg-white" type="text" name="text" id="text-comment"
                          style="border: 1px solid black!important; resize: none"
                          placeholder="Enter Your Comment ..."
                          rows="5"></textarea>
                <br>
                <button class="btn btn-info" id="btn_comment" name="btn_comment" onclick="submitComment()"
                        type="submit">Submit new Comment
                </button>
            </div>
        </div>
    </div>


    {#      <textarea id="mySavedModel" style="width:100%;height:300px">#}
    {#          {{ a }}#}
    {#      </textarea>#}



{% endblock %}







